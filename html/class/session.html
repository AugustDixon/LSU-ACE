<html>
	<head>
		<title>Take Notes</title>
	</head>
	<body>
		<a href="index.php">Back</a>
		<input type="button" value="Save Work" onClick="autosave()">
		<input type="button" value="Save to Computer" onClick="download()"><br>
		<textarea rows="150" cols="100" wrap="hard" id="notes"></textarea>
		<textarea rows="50" cols="60" wrap="soft" id="chat" readonly></textarea>
		<textarea rows="2" cols="60" wrap="soft" id="message"></textarea>
		<input type="button" value="Send Message" onClick="sendMessage()">
		
		
		<script>
			window.onLoad(load());
			window.setInterval(autosave(), 30000);
			window.setInterval(pingChat(), 5000);
			var Mid = '0';
			
			function download() {
				var notes = document.getElementById("notes").value;
				var file = new Blob([notes], {type: "text/plain"});
				
				if (window.navigator.msSaveOrOpenBlob)
					window.navigator.msSaveOrOpenBlob(file, notes.txt);
				else {
					var a = document.createElement("a"),
					url = URL.createObjectURL(file);
					a.href = url;
					a.download = "notes.txt";
					document.body.appendChild(a);
					a.click();
					setTimeout(function() {
						document.body.removeChild(a);
						window.URL.revokeObjectURL(url);  
					}, 0); 
				}
			}
			
			function load(){
				
				var attributes = 'ID=$ID';
				
				var xhttp;
				xhttp=new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						finishLoad(this);
					}
				};
				xhttp.open("POST", "functions/load.php", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send(attributes);
			}
			
			function finishLoad(xhttp){
				switch(xhttp.responseText){
					case "0":
						alert("Load Script Failure");
						window.location = index.php;
						break;
					default:
						document.getElementById("notes").value = xhttp.responseText;
			}
			
			function autosave(){
				
				var text = document.getElementById("notes").value;
				var attributes = 'ID=$ID&text=' + escape(text);
				
				var xhttp;
				xhttp=new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						finishAutosave(this);
					}
				};
				xhttp.open("POST", "functions/autosave.php", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send(attributes);
			}
			
			function finishAutosave(xhttp){
				switch(xhttp.responseText){
					case "0":
						alert("Autosave failure");
						break;
					case "1":
						break;
					default:
						alert("Autosave Unknown Error");
				}
			}
			
			function pingChat(){
				
				var attributes = 'ID=$ID&Mid=' + Mid;
				
				var xhttp;
				xhttp=new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						finishPingChat(this);
					}
				};
				xhttp.open("POST", "functions/pingChat.php", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send(attributes);
			}
			
			function finishPingChat(xhttp){
				var x = xhttp.responseText;
				if(x.charAt(0) != '0'){
					var i = 0;
					var temp = '';
					while(x.charAt(i) != ' '){
						temp += x.charAt(i);
						i++;
					}
					i++;
					Mid = tempMid;
					var chat = document.getElementById("chat").value;
					while(i < x.length){
						chat += x.charAt(i);
						i++;
					}
				}
			}
			
			function sendMessage(){
				
				var message = document.getElementById("message").value;
				
				var attributes = 'ID=$ID&message=' + escape(message);
				
				var xhttp;
				xhttp=new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						finishSendMessage(this);
					}
				};
				xhttp.open("POST", url, true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send(attributes);
			}
			
			function finishSendMessage(xhttp){
			
			}
		</script>
	</body>
</html>